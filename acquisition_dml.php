<?php

// Data functions (insert, update, delete, form) for table acquisition

// This script and data application were generated by AppGini 5.51
// Download AppGini for free from http://bigprof.com/appgini/download/

function acquisition_insert(){
	global $Translation;

	// mm: can member insert record?
	$arrPerm=getTablePermissions('acquisition');
	if(!$arrPerm[1]){
		return false;
	}

	$data['call_back'] = makeSafe($_REQUEST['call_back']);
		if($data['call_back'] == empty_lookup_value){ $data['call_back'] = ''; }
	$data['seller_name'] = makeSafe($_REQUEST['seller_name']);
		if($data['seller_name'] == empty_lookup_value){ $data['seller_name'] = ''; }
	$data['phone'] = makeSafe($_REQUEST['phone']);
		if($data['phone'] == empty_lookup_value){ $data['phone'] = ''; }
	$data['purchase_notes'] = makeSafe($_REQUEST['purchase_notes']);
		if($data['purchase_notes'] == empty_lookup_value){ $data['purchase_notes'] = ''; }
	$data['priority'] = makeSafe($_REQUEST['priority']);
		if($data['priority'] == empty_lookup_value){ $data['priority'] = ''; }
	$data['location_city'] = makeSafe($_REQUEST['location_city']);
		if($data['location_city'] == empty_lookup_value){ $data['location_city'] = ''; }
	$data['location_state'] = makeSafe($_REQUEST['location_state']);
		if($data['location_state'] == empty_lookup_value){ $data['location_state'] = ''; }
	$data['pickup_date'] = intval($_REQUEST['pickup_dateYear']) . '-' . intval($_REQUEST['pickup_dateMonth']) . '-' . intval($_REQUEST['pickup_dateDay']);
	$data['pickup_date'] = parseMySQLDate($data['pickup_date'], '1');
	$data['pickup_time'] = makeSafe($_REQUEST['pickup_time']);
		if($data['pickup_time'] == empty_lookup_value){ $data['pickup_time'] = ''; }
	$data['pickup_time'] = time24($data['pickup_time']);
	$data['street_address'] = makeSafe($_REQUEST['street_address']);
		if($data['street_address'] == empty_lookup_value){ $data['street_address'] = ''; }
	$data['category'] = makeSafe($_REQUEST['category']);
		if($data['category'] == empty_lookup_value){ $data['category'] = ''; }
	$data['ref_listing'] = makeSafe($_REQUEST['ref_listing']);
		if($data['ref_listing'] == empty_lookup_value){ $data['ref_listing'] = ''; }
	$data['photo_1'] = PrepareUploadedFile('photo_1', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_1']) createThumbnail($data['photo_1'], getThumbnailSpecs('acquisition', 'photo_1', 'tv'));
	if($data['photo_1']) createThumbnail($data['photo_1'], getThumbnailSpecs('acquisition', 'photo_1', 'dv'));
	$data['photo_2'] = PrepareUploadedFile('photo_2', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_2']) createThumbnail($data['photo_2'], getThumbnailSpecs('acquisition', 'photo_2', 'tv'));
	if($data['photo_2']) createThumbnail($data['photo_2'], getThumbnailSpecs('acquisition', 'photo_2', 'dv'));
	$data['photo_3'] = PrepareUploadedFile('photo_3', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_3']) createThumbnail($data['photo_3'], getThumbnailSpecs('acquisition', 'photo_3', 'tv'));
	if($data['photo_3']) createThumbnail($data['photo_3'], getThumbnailSpecs('acquisition', 'photo_3', 'dv'));
	$data['photo_4'] = PrepareUploadedFile('photo_4', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_4']) createThumbnail($data['photo_4'], getThumbnailSpecs('acquisition', 'photo_4', 'tv'));
	if($data['photo_4']) createThumbnail($data['photo_4'], getThumbnailSpecs('acquisition', 'photo_4', 'dv'));
	$data['photo_5'] = PrepareUploadedFile('photo_5', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_5']) createThumbnail($data['photo_5'], getThumbnailSpecs('acquisition', 'photo_5', 'tv'));
	if($data['photo_5']) createThumbnail($data['photo_5'], getThumbnailSpecs('acquisition', 'photo_5', 'dv'));
	$data['photo_6'] = PrepareUploadedFile('photo_6', 4096000,'jpg|jpeg|gif|png', false, '');
	if($data['photo_6']) createThumbnail($data['photo_6'], getThumbnailSpecs('acquisition', 'photo_6', 'tv'));
	if($data['photo_6']) createThumbnail($data['photo_6'], getThumbnailSpecs('acquisition', 'photo_6', 'dv'));
	if($data['seller_name']== ''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">" . $Translation['error:'] . " 'Seller name': " . $Translation['field not null'] . '<br><br>';
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	if($data['phone']== ''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">" . $Translation['error:'] . " 'Phone': " . $Translation['field not null'] . '<br><br>';
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	if($data['priority'] == '') $data['priority'] = "Normal";
	if($data['priority']== ''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">" . $Translation['error:'] . " 'Purchase Priority': " . $Translation['field not null'] . '<br><br>';
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	if($data['category']== ''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">" . $Translation['error:'] . " 'Category': " . $Translation['field not null'] . '<br><br>';
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}

	/* for empty upload fields, when saving a copy of an existing record, copy the original upload field */
	if($_REQUEST['SelectedID']){
		$res = sql("select * from acquisition where id='" . makeSafe($_REQUEST['SelectedID']) . "'", $eo);
		if($row = db_fetch_assoc($res)){
			if(!$data['photo_1']) $data['photo_1'] = makeSafe($row['photo_1']);
			if(!$data['photo_2']) $data['photo_2'] = makeSafe($row['photo_2']);
			if(!$data['photo_3']) $data['photo_3'] = makeSafe($row['photo_3']);
			if(!$data['photo_4']) $data['photo_4'] = makeSafe($row['photo_4']);
			if(!$data['photo_5']) $data['photo_5'] = makeSafe($row['photo_5']);
			if(!$data['photo_6']) $data['photo_6'] = makeSafe($row['photo_6']);
		}
	}

	// hook: acquisition_before_insert
	if(function_exists('acquisition_before_insert')){
		$args=array();
		if(!acquisition_before_insert($data, getMemberInfo(), $args)){ return false; }
	}

	$o = array('silentErrors' => true);
	sql('insert into `acquisition` set       `call_back`=' . (($data['call_back'] !== '' && $data['call_back'] !== NULL) ? "'{$data['call_back']}'" : 'NULL') . ', `seller_name`=' . (($data['seller_name'] !== '' && $data['seller_name'] !== NULL) ? "'{$data['seller_name']}'" : 'NULL') . ', `phone`=' . (($data['phone'] !== '' && $data['phone'] !== NULL) ? "'{$data['phone']}'" : 'NULL') . ', `purchase_notes`=' . (($data['purchase_notes'] !== '' && $data['purchase_notes'] !== NULL) ? "'{$data['purchase_notes']}'" : 'NULL') . ', `priority`=' . (($data['priority'] !== '' && $data['priority'] !== NULL) ? "'{$data['priority']}'" : 'NULL') . ', `location_city`=' . (($data['location_city'] !== '' && $data['location_city'] !== NULL) ? "'{$data['location_city']}'" : 'NULL') . ', `location_state`=' . (($data['location_state'] !== '' && $data['location_state'] !== NULL) ? "'{$data['location_state']}'" : 'NULL') . ', `pickup_date`=' . (($data['pickup_date'] !== '' && $data['pickup_date'] !== NULL) ? "'{$data['pickup_date']}'" : 'NULL') . ', `pickup_time`=' . (($data['pickup_time'] !== '' && $data['pickup_time'] !== NULL) ? "'{$data['pickup_time']}'" : 'NULL') . ', `street_address`=' . (($data['street_address'] !== '' && $data['street_address'] !== NULL) ? "'{$data['street_address']}'" : 'NULL') . ', `category`=' . (($data['category'] !== '' && $data['category'] !== NULL) ? "'{$data['category']}'" : 'NULL') . ', `ref_listing`=' . (($data['ref_listing'] !== '' && $data['ref_listing'] !== NULL) ? "'{$data['ref_listing']}'" : 'NULL') . ', ' . ($data['photo_1'] != '' ? "`photo_1`='{$data['photo_1']}'" : '`photo_1`=NULL') . ', ' . ($data['photo_2'] != '' ? "`photo_2`='{$data['photo_2']}'" : '`photo_2`=NULL') . ', ' . ($data['photo_3'] != '' ? "`photo_3`='{$data['photo_3']}'" : '`photo_3`=NULL') . ', ' . ($data['photo_4'] != '' ? "`photo_4`='{$data['photo_4']}'" : '`photo_4`=NULL') . ', ' . ($data['photo_5'] != '' ? "`photo_5`='{$data['photo_5']}'" : '`photo_5`=NULL') . ', ' . ($data['photo_6'] != '' ? "`photo_6`='{$data['photo_6']}'" : '`photo_6`=NULL'), $o);
	if($o['error']!=''){
		echo $o['error'];
		echo "<a href=\"acquisition_view.php?addNew_x=1\">{$Translation['< back']}</a>";
		exit;
	}

	$recID = db_insert_id(db_link());

	// hook: acquisition_after_insert
	if(function_exists('acquisition_after_insert')){
		$res = sql("select * from `acquisition` where `id`='" . makeSafe($recID, false) . "' limit 1", $eo);
		if($row = db_fetch_assoc($res)){
			$data = array_map('makeSafe', $row);
		}
		$data['selectedID'] = makeSafe($recID, false);
		$args=array();
		if(!acquisition_after_insert($data, getMemberInfo(), $args)){ return $recID; }
	}

	// mm: save ownership data
	sql("insert ignore into membership_userrecords set tableName='acquisition', pkValue='" . makeSafe($recID, false) . "', memberID='" . makeSafe(getLoggedMemberID(), false) . "', dateAdded='" . time() . "', dateUpdated='" . time() . "', groupID='" . getLoggedGroupID() . "'", $eo);

	return $recID;
}

function acquisition_delete($selected_id, $AllowDeleteOfParents=false, $skipChecks=false){
	// insure referential integrity ...
	global $Translation;
	$selected_id=makeSafe($selected_id);

	// mm: can member delete record?
	$arrPerm=getTablePermissions('acquisition');
	$ownerGroupID=sqlValue("select groupID from membership_userrecords where tableName='acquisition' and pkValue='$selected_id'");
	$ownerMemberID=sqlValue("select lcase(memberID) from membership_userrecords where tableName='acquisition' and pkValue='$selected_id'");
	if(($arrPerm[4]==1 && $ownerMemberID==getLoggedMemberID()) || ($arrPerm[4]==2 && $ownerGroupID==getLoggedGroupID()) || $arrPerm[4]==3){ // allow delete?
		// delete allowed, so continue ...
	}else{
		return $Translation['You don\'t have enough permissions to delete this record'];
	}

	// hook: acquisition_before_delete
	if(function_exists('acquisition_before_delete')){
		$args=array();
		if(!acquisition_before_delete($selected_id, $skipChecks, getMemberInfo(), $args))
			return $Translation['Couldn\'t delete this record'];
	}

	// delete file stored in the 'photo_1' field
	$res = sql("select `photo_1` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	// delete file stored in the 'photo_2' field
	$res = sql("select `photo_2` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	// delete file stored in the 'photo_3' field
	$res = sql("select `photo_3` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	// delete file stored in the 'photo_4' field
	$res = sql("select `photo_4` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	// delete file stored in the 'photo_5' field
	$res = sql("select `photo_5` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	// delete file stored in the 'photo_6' field
	$res = sql("select `photo_6` from `acquisition` where `id`='$selected_id'", $eo);
	if($row=@db_fetch_row($res)){
		if($row[0]!=''){
			@unlink(getUploadDir('').$row[0]);
			preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
			$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
			$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
			@unlink(getUploadDir('').$thumbTV);
			@unlink(getUploadDir('').$thumbDV);
		}
	}

	sql("delete from `acquisition` where `id`='$selected_id'", $eo);

	// hook: acquisition_after_delete
	if(function_exists('acquisition_after_delete')){
		$args=array();
		acquisition_after_delete($selected_id, getMemberInfo(), $args);
	}

	// mm: delete ownership data
	sql("delete from membership_userrecords where tableName='acquisition' and pkValue='$selected_id'", $eo);
}

function acquisition_update($selected_id){
	global $Translation;

	// mm: can member edit record?
	$arrPerm=getTablePermissions('acquisition');
	$ownerGroupID=sqlValue("select groupID from membership_userrecords where tableName='acquisition' and pkValue='".makeSafe($selected_id)."'");
	$ownerMemberID=sqlValue("select lcase(memberID) from membership_userrecords where tableName='acquisition' and pkValue='".makeSafe($selected_id)."'");
	if(($arrPerm[3]==1 && $ownerMemberID==getLoggedMemberID()) || ($arrPerm[3]==2 && $ownerGroupID==getLoggedGroupID()) || $arrPerm[3]==3){ // allow update?
		// update allowed, so continue ...
	}else{
		return false;
	}

	$data['call_back'] = makeSafe($_REQUEST['call_back']);
		if($data['call_back'] == empty_lookup_value){ $data['call_back'] = ''; }
	$data['seller_name'] = makeSafe($_REQUEST['seller_name']);
		if($data['seller_name'] == empty_lookup_value){ $data['seller_name'] = ''; }
	if($data['seller_name']==''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">{$Translation['error:']} 'Seller name': {$Translation['field not null']}<br><br>";
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	$data['phone'] = makeSafe($_REQUEST['phone']);
		if($data['phone'] == empty_lookup_value){ $data['phone'] = ''; }
	if($data['phone']==''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">{$Translation['error:']} 'Phone': {$Translation['field not null']}<br><br>";
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	$data['purchase_notes'] = makeSafe($_REQUEST['purchase_notes']);
		if($data['purchase_notes'] == empty_lookup_value){ $data['purchase_notes'] = ''; }
	$data['priority'] = makeSafe($_REQUEST['priority']);
		if($data['priority'] == empty_lookup_value){ $data['priority'] = ''; }
	if($data['priority']==''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">{$Translation['error:']} 'Purchase Priority': {$Translation['field not null']}<br><br>";
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	$data['location_city'] = makeSafe($_REQUEST['location_city']);
		if($data['location_city'] == empty_lookup_value){ $data['location_city'] = ''; }
	$data['location_state'] = makeSafe($_REQUEST['location_state']);
		if($data['location_state'] == empty_lookup_value){ $data['location_state'] = ''; }
	$data['pickup_date'] = intval($_REQUEST['pickup_dateYear']) . '-' . intval($_REQUEST['pickup_dateMonth']) . '-' . intval($_REQUEST['pickup_dateDay']);
	$data['pickup_date'] = parseMySQLDate($data['pickup_date'], '1');
	$data['pickup_time'] = makeSafe($_REQUEST['pickup_time']);
		if($data['pickup_time'] == empty_lookup_value){ $data['pickup_time'] = ''; }
	$data['pickup_time'] = time24($data['pickup_time']);
	$data['street_address'] = makeSafe($_REQUEST['street_address']);
		if($data['street_address'] == empty_lookup_value){ $data['street_address'] = ''; }
	$data['category'] = makeSafe($_REQUEST['category']);
		if($data['category'] == empty_lookup_value){ $data['category'] = ''; }
	if($data['category']==''){
		echo StyleSheet() . "\n\n<div class=\"alert alert-danger\">{$Translation['error:']} 'Category': {$Translation['field not null']}<br><br>";
		echo '<a href="" onclick="history.go(-1); return false;">'.$Translation['< back'].'</a></div>';
		exit;
	}
	$data['ref_listing'] = makeSafe($_REQUEST['ref_listing']);
		if($data['ref_listing'] == empty_lookup_value){ $data['ref_listing'] = ''; }
	$data['selectedID']=makeSafe($selected_id);
	if($_REQUEST['photo_1_remove'] == 1){
		$data['photo_1'] = '';
		// delete file from server
		$res = sql("select `photo_1` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_1'] = PrepareUploadedFile('photo_1', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_1']) createThumbnail($data['photo_1'], getThumbnailSpecs('acquisition', 'photo_1', 'tv'));
		if($data['photo_1']) createThumbnail($data['photo_1'], getThumbnailSpecs('acquisition', 'photo_1', 'dv'));
		// delete file from server
		if($data['photo_1'] != ''){
			$res = sql("select `photo_1` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}
	if($_REQUEST['photo_2_remove'] == 1){
		$data['photo_2'] = '';
		// delete file from server
		$res = sql("select `photo_2` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_2'] = PrepareUploadedFile('photo_2', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_2']) createThumbnail($data['photo_2'], getThumbnailSpecs('acquisition', 'photo_2', 'tv'));
		if($data['photo_2']) createThumbnail($data['photo_2'], getThumbnailSpecs('acquisition', 'photo_2', 'dv'));
		// delete file from server
		if($data['photo_2'] != ''){
			$res = sql("select `photo_2` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}
	if($_REQUEST['photo_3_remove'] == 1){
		$data['photo_3'] = '';
		// delete file from server
		$res = sql("select `photo_3` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_3'] = PrepareUploadedFile('photo_3', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_3']) createThumbnail($data['photo_3'], getThumbnailSpecs('acquisition', 'photo_3', 'tv'));
		if($data['photo_3']) createThumbnail($data['photo_3'], getThumbnailSpecs('acquisition', 'photo_3', 'dv'));
		// delete file from server
		if($data['photo_3'] != ''){
			$res = sql("select `photo_3` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}
	if($_REQUEST['photo_4_remove'] == 1){
		$data['photo_4'] = '';
		// delete file from server
		$res = sql("select `photo_4` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_4'] = PrepareUploadedFile('photo_4', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_4']) createThumbnail($data['photo_4'], getThumbnailSpecs('acquisition', 'photo_4', 'tv'));
		if($data['photo_4']) createThumbnail($data['photo_4'], getThumbnailSpecs('acquisition', 'photo_4', 'dv'));
		// delete file from server
		if($data['photo_4'] != ''){
			$res = sql("select `photo_4` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}
	if($_REQUEST['photo_5_remove'] == 1){
		$data['photo_5'] = '';
		// delete file from server
		$res = sql("select `photo_5` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_5'] = PrepareUploadedFile('photo_5', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_5']) createThumbnail($data['photo_5'], getThumbnailSpecs('acquisition', 'photo_5', 'tv'));
		if($data['photo_5']) createThumbnail($data['photo_5'], getThumbnailSpecs('acquisition', 'photo_5', 'dv'));
		// delete file from server
		if($data['photo_5'] != ''){
			$res = sql("select `photo_5` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}
	if($_REQUEST['photo_6_remove'] == 1){
		$data['photo_6'] = '';
		// delete file from server
		$res = sql("select `photo_6` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if($row=@db_fetch_row($res)){
			if($row[0]!=''){
				@unlink(getUploadDir('').$row[0]);
				preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
				$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
				$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
				@unlink(getUploadDir('').$thumbTV);
				@unlink(getUploadDir('').$thumbDV);
			}
		}
	}else{
		$data['photo_6'] = PrepareUploadedFile('photo_6', 4096000, 'jpg|jpeg|gif|png', false, "");
		if($data['photo_6']) createThumbnail($data['photo_6'], getThumbnailSpecs('acquisition', 'photo_6', 'tv'));
		if($data['photo_6']) createThumbnail($data['photo_6'], getThumbnailSpecs('acquisition', 'photo_6', 'dv'));
		// delete file from server
		if($data['photo_6'] != ''){
			$res = sql("select `photo_6` from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
			if($row=@db_fetch_row($res)){
				if($row[0]!=''){
					@unlink(getUploadDir('').$row[0]);
					preg_match('/^[a-z0-9_]+\.(gif|png|jpg|jpeg|jpe)$/i', $row[0], $m);
					$thumbDV=str_replace(".$m[1]ffffgggg", "_dv.$m[1]", $row[0].'ffffgggg');
					$thumbTV=str_replace(".$m[1]ffffgggg", "_tv.$m[1]", $row[0].'ffffgggg');
					@unlink(getUploadDir('').$thumbTV);
					@unlink(getUploadDir('').$thumbDV);
				}
			}
		}
	}

	// hook: acquisition_before_update
	if(function_exists('acquisition_before_update')){
		$args=array();
		if(!acquisition_before_update($data, getMemberInfo(), $args)){ return false; }
	}

	$o=array('silentErrors' => true);
	sql('update `acquisition` set       `call_back`=' . (($data['call_back'] !== '' && $data['call_back'] !== NULL) ? "'{$data['call_back']}'" : 'NULL') . ', `seller_name`=' . (($data['seller_name'] !== '' && $data['seller_name'] !== NULL) ? "'{$data['seller_name']}'" : 'NULL') . ', `phone`=' . (($data['phone'] !== '' && $data['phone'] !== NULL) ? "'{$data['phone']}'" : 'NULL') . ', `purchase_notes`=' . (($data['purchase_notes'] !== '' && $data['purchase_notes'] !== NULL) ? "'{$data['purchase_notes']}'" : 'NULL') . ', `priority`=' . (($data['priority'] !== '' && $data['priority'] !== NULL) ? "'{$data['priority']}'" : 'NULL') . ', `location_city`=' . (($data['location_city'] !== '' && $data['location_city'] !== NULL) ? "'{$data['location_city']}'" : 'NULL') . ', `location_state`=' . (($data['location_state'] !== '' && $data['location_state'] !== NULL) ? "'{$data['location_state']}'" : 'NULL') . ', `pickup_date`=' . (($data['pickup_date'] !== '' && $data['pickup_date'] !== NULL) ? "'{$data['pickup_date']}'" : 'NULL') . ', `pickup_time`=' . (($data['pickup_time'] !== '' && $data['pickup_time'] !== NULL) ? "'{$data['pickup_time']}'" : 'NULL') . ', `street_address`=' . (($data['street_address'] !== '' && $data['street_address'] !== NULL) ? "'{$data['street_address']}'" : 'NULL') . ', `category`=' . (($data['category'] !== '' && $data['category'] !== NULL) ? "'{$data['category']}'" : 'NULL') . ', `ref_listing`=' . (($data['ref_listing'] !== '' && $data['ref_listing'] !== NULL) ? "'{$data['ref_listing']}'" : 'NULL') . ', ' . ($data['photo_1']!='' ? "`photo_1`='{$data['photo_1']}'" : ($_REQUEST['photo_1_remove'] != 1 ? '`photo_1`=`photo_1`' : '`photo_1`=NULL')) . ', ' . ($data['photo_2']!='' ? "`photo_2`='{$data['photo_2']}'" : ($_REQUEST['photo_2_remove'] != 1 ? '`photo_2`=`photo_2`' : '`photo_2`=NULL')) . ', ' . ($data['photo_3']!='' ? "`photo_3`='{$data['photo_3']}'" : ($_REQUEST['photo_3_remove'] != 1 ? '`photo_3`=`photo_3`' : '`photo_3`=NULL')) . ', ' . ($data['photo_4']!='' ? "`photo_4`='{$data['photo_4']}'" : ($_REQUEST['photo_4_remove'] != 1 ? '`photo_4`=`photo_4`' : '`photo_4`=NULL')) . ', ' . ($data['photo_5']!='' ? "`photo_5`='{$data['photo_5']}'" : ($_REQUEST['photo_5_remove'] != 1 ? '`photo_5`=`photo_5`' : '`photo_5`=NULL')) . ', ' . ($data['photo_6']!='' ? "`photo_6`='{$data['photo_6']}'" : ($_REQUEST['photo_6_remove'] != 1 ? '`photo_6`=`photo_6`' : '`photo_6`=NULL')) . " where `id`='".makeSafe($selected_id)."'", $o);
	if($o['error']!=''){
		echo $o['error'];
		echo '<a href="acquisition_view.php?SelectedID='.urlencode($selected_id)."\">{$Translation['< back']}</a>";
		exit;
	}


	// hook: acquisition_after_update
	if(function_exists('acquisition_after_update')){
		$res = sql("SELECT * FROM `acquisition` WHERE `id`='{$data['selectedID']}' LIMIT 1", $eo);
		if($row = db_fetch_assoc($res)){
			$data = array_map('makeSafe', $row);
		}
		$data['selectedID'] = $data['id'];
		$args = array();
		if(!acquisition_after_update($data, getMemberInfo(), $args)){ return; }
	}

	// mm: update ownership data
	sql("update membership_userrecords set dateUpdated='".time()."' where tableName='acquisition' and pkValue='".makeSafe($selected_id)."'", $eo);

}

function acquisition_form($selected_id = '', $AllowUpdate = 1, $AllowInsert = 1, $AllowDelete = 1, $ShowCancel = 0){
	// function to return an editable form for a table records
	// and fill it with data of record whose ID is $selected_id. If $selected_id
	// is empty, an empty form is shown, with only an 'Add New'
	// button displayed.

	global $Translation;

	// mm: get table permissions
	$arrPerm=getTablePermissions('acquisition');
	if(!$arrPerm[1] && $selected_id==''){ return ''; }
	$AllowInsert = ($arrPerm[1] ? true : false);
	// print preview?
	$dvprint = false;
	if($selected_id && $_REQUEST['dvprint_x'] != ''){
		$dvprint = true;
	}


	// populate filterers, starting from children to grand-parents

	// unique random identifier
	$rnd1 = ($dvprint ? rand(1000000, 9999999) : '');
	// combobox: call_back
	$combo_call_back = new Combo;
	$combo_call_back->ListType = 0;
	$combo_call_back->MultipleSeparator = ', ';
	$combo_call_back->ListBoxHeight = 10;
	$combo_call_back->RadiosPerLine = 1;
	if(is_file(dirname(__FILE__).'/hooks/acquisition.call_back.csv')){
		$call_back_data = addslashes(implode('', @file(dirname(__FILE__).'/hooks/acquisition.call_back.csv')));
		$combo_call_back->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions($call_back_data)));
		$combo_call_back->ListData = $combo_call_back->ListItem;
	}else{
		$combo_call_back->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions("Monday;;Tuesday;;Wednesday;;Thursday;;Friday;;Saturday;;Sunday")));
		$combo_call_back->ListData = $combo_call_back->ListItem;
	}
	$combo_call_back->SelectName = 'call_back';
	// combobox: priority
	$combo_priority = new Combo;
	$combo_priority->ListType = 2;
	$combo_priority->MultipleSeparator = ', ';
	$combo_priority->ListBoxHeight = 10;
	$combo_priority->RadiosPerLine = 1;
	if(is_file(dirname(__FILE__).'/hooks/acquisition.priority.csv')){
		$priority_data = addslashes(implode('', @file(dirname(__FILE__).'/hooks/acquisition.priority.csv')));
		$combo_priority->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions($priority_data)));
		$combo_priority->ListData = $combo_priority->ListItem;
	}else{
		$combo_priority->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions("Normal;;Low;;High")));
		$combo_priority->ListData = $combo_priority->ListItem;
	}
	$combo_priority->SelectName = 'priority';
	$combo_priority->AllowNull = false;
	// combobox: location_state
	$combo_location_state = new Combo;
	$combo_location_state->ListType = 0;
	$combo_location_state->MultipleSeparator = ', ';
	$combo_location_state->ListBoxHeight = 10;
	$combo_location_state->RadiosPerLine = 1;
	if(is_file(dirname(__FILE__).'/hooks/acquisition.location_state.csv')){
		$location_state_data = addslashes(implode('', @file(dirname(__FILE__).'/hooks/acquisition.location_state.csv')));
		$combo_location_state->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions($location_state_data)));
		$combo_location_state->ListData = $combo_location_state->ListItem;
	}else{
		$combo_location_state->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions("New Jersey (NJ);;Pennsylvania (PA);;New York (NY);;Delaware (DE)")));
		$combo_location_state->ListData = $combo_location_state->ListItem;
	}
	$combo_location_state->SelectName = 'location_state';
	// combobox: pickup_date
	$combo_pickup_date = new DateCombo;
	$combo_pickup_date->DateFormat = "mdy";
	$combo_pickup_date->MinYear = 1900;
	$combo_pickup_date->MaxYear = 2100;
	$combo_pickup_date->DefaultDate = parseMySQLDate('1', '1');
	$combo_pickup_date->MonthNames = $Translation['month names'];
	$combo_pickup_date->NamePrefix = 'pickup_date';
	// combobox: category
	$combo_category = new Combo;
	$combo_category->ListType = 0;
	$combo_category->MultipleSeparator = ', ';
	$combo_category->ListBoxHeight = 10;
	$combo_category->RadiosPerLine = 1;
	if(is_file(dirname(__FILE__).'/hooks/acquisition.category.csv')){
		$category_data = addslashes(implode('', @file(dirname(__FILE__).'/hooks/acquisition.category.csv')));
		$combo_category->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions($category_data)));
		$combo_category->ListData = $combo_category->ListItem;
	}else{
		$combo_category->ListItem = explode('||', entitiesToUTF8(convertLegacyOptions("Other;;Brass;;Strings;;Woodwind;;Percussion;;Keyboard")));
		$combo_category->ListData = $combo_category->ListItem;
	}
	$combo_category->SelectName = 'category';
	$combo_category->AllowNull = false;

	if($selected_id){
		// mm: check member permissions
		if(!$arrPerm[2]){
			return "";
		}
		// mm: who is the owner?
		$ownerGroupID=sqlValue("select groupID from membership_userrecords where tableName='acquisition' and pkValue='".makeSafe($selected_id)."'");
		$ownerMemberID=sqlValue("select lcase(memberID) from membership_userrecords where tableName='acquisition' and pkValue='".makeSafe($selected_id)."'");
		if($arrPerm[2]==1 && getLoggedMemberID()!=$ownerMemberID){
			return "";
		}
		if($arrPerm[2]==2 && getLoggedGroupID()!=$ownerGroupID){
			return "";
		}

		// can edit?
		if(($arrPerm[3]==1 && $ownerMemberID==getLoggedMemberID()) || ($arrPerm[3]==2 && $ownerGroupID==getLoggedGroupID()) || $arrPerm[3]==3){
			$AllowUpdate=1;
		}else{
			$AllowUpdate=0;
		}

		$res = sql("select * from `acquisition` where `id`='".makeSafe($selected_id)."'", $eo);
		if(!($row = db_fetch_array($res))){
			return error_message($Translation['No records found']);
		}
		$urow = $row; /* unsanitized data */
		$hc = new CI_Input();
		$row = $hc->xss_clean($row); /* sanitize data */
		$combo_call_back->SelectedData = $row['call_back'];
		$combo_priority->SelectedData = $row['priority'];
		$combo_location_state->SelectedData = $row['location_state'];
		$combo_pickup_date->DefaultDate = $row['pickup_date'];
		$combo_category->SelectedData = $row['category'];
	}else{
		$combo_call_back->SelectedText = ( $_REQUEST['FilterField'][1]=='2' && $_REQUEST['FilterOperator'][1]=='<=>' ? (get_magic_quotes_gpc() ? stripslashes($_REQUEST['FilterValue'][1]) : $_REQUEST['FilterValue'][1]) : "");
		$combo_priority->SelectedText = ( $_REQUEST['FilterField'][1]=='6' && $_REQUEST['FilterOperator'][1]=='<=>' ? (get_magic_quotes_gpc() ? stripslashes($_REQUEST['FilterValue'][1]) : $_REQUEST['FilterValue'][1]) : "Normal");
		$combo_location_state->SelectedText = ( $_REQUEST['FilterField'][1]=='8' && $_REQUEST['FilterOperator'][1]=='<=>' ? (get_magic_quotes_gpc() ? stripslashes($_REQUEST['FilterValue'][1]) : $_REQUEST['FilterValue'][1]) : "");
		$combo_category->SelectedText = ( $_REQUEST['FilterField'][1]=='12' && $_REQUEST['FilterOperator'][1]=='<=>' ? (get_magic_quotes_gpc() ? stripslashes($_REQUEST['FilterValue'][1]) : $_REQUEST['FilterValue'][1]) : "");
	}
	$combo_call_back->Render();
	$combo_priority->Render();
	$combo_location_state->Render();
	$combo_category->Render();

	// code for template based detail view forms

	// open the detail view template
	if($dvprint){
		$templateCode = @file_get_contents('./templates/acquisition_templateDVP.html');
	}else{
		$templateCode = @file_get_contents('./templates/acquisition_templateDV.html');
	}

	// process form title
	$templateCode = str_replace('<%%DETAIL_VIEW_TITLE%%>', 'Detail View', $templateCode);
	$templateCode = str_replace('<%%RND1%%>', $rnd1, $templateCode);
	$templateCode = str_replace('<%%EMBEDDED%%>', ($_REQUEST['Embedded'] ? 'Embedded=1' : ''), $templateCode);
	// process buttons
	if($arrPerm[1] && !$selected_id){ // allow insert and no record selected?
		if(!$selected_id) $templateCode=str_replace('<%%INSERT_BUTTON%%>', '<button type="submit" class="btn btn-success" id="insert" name="insert_x" value="1" onclick="return acquisition_validateData();"><i class="glyphicon glyphicon-plus-sign"></i> ' . $Translation['Save New'] . '</button>', $templateCode);
		$templateCode=str_replace('<%%INSERT_BUTTON%%>', '<button type="submit" class="btn btn-default" id="insert" name="insert_x" value="1" onclick="return acquisition_validateData();"><i class="glyphicon glyphicon-plus-sign"></i> ' . $Translation['Save As Copy'] . '</button>', $templateCode);
	}else{
		$templateCode=str_replace('<%%INSERT_BUTTON%%>', '', $templateCode);
	}

	// 'Back' button action
	if($_REQUEST['Embedded']){
		$backAction = 'window.parent.jQuery(\'.modal\').modal(\'hide\'); return false;';
	}else{
		$backAction = '$$(\'form\')[0].writeAttribute(\'novalidate\', \'novalidate\'); document.myform.reset(); return true;';
	}

	if($selected_id){
		if(!$_REQUEST['Embedded']) $templateCode=str_replace('<%%DVPRINT_BUTTON%%>', '<button type="submit" class="btn btn-default" id="dvprint" name="dvprint_x" value="1" onclick="$$(\'form\')[0].writeAttribute(\'novalidate\', \'novalidate\'); document.myform.reset(); return true;"><i class="glyphicon glyphicon-print"></i> ' . $Translation['Print Preview'] . '</button>', $templateCode);
		if($AllowUpdate){
			$templateCode=str_replace('<%%UPDATE_BUTTON%%>', '<button type="submit" class="btn btn-success btn-lg" id="update" name="update_x" value="1" onclick="return acquisition_validateData();"><i class="glyphicon glyphicon-ok"></i> ' . $Translation['Save Changes'] . '</button>', $templateCode);
		}else{
			$templateCode=str_replace('<%%UPDATE_BUTTON%%>', '', $templateCode);
		}
		if(($arrPerm[4]==1 && $ownerMemberID==getLoggedMemberID()) || ($arrPerm[4]==2 && $ownerGroupID==getLoggedGroupID()) || $arrPerm[4]==3){ // allow delete?
			$templateCode=str_replace('<%%DELETE_BUTTON%%>', '<button type="submit" class="btn btn-danger" id="delete" name="delete_x" value="1" onclick="return confirm(\'' . $Translation['are you sure?'] . '\');"><i class="glyphicon glyphicon-trash"></i> ' . $Translation['Delete'] . '</button>', $templateCode);
		}else{
			$templateCode=str_replace('<%%DELETE_BUTTON%%>', '', $templateCode);
		}
		$templateCode=str_replace('<%%DESELECT_BUTTON%%>', '<button type="submit" class="btn btn-default" id="deselect" name="deselect_x" value="1" onclick="' . $backAction . '"><i class="glyphicon glyphicon-chevron-left"></i> ' . $Translation['Back'] . '</button>', $templateCode);
	}else{
		$templateCode=str_replace('<%%UPDATE_BUTTON%%>', '', $templateCode);
		$templateCode=str_replace('<%%DELETE_BUTTON%%>', '', $templateCode);
		$templateCode=str_replace('<%%DESELECT_BUTTON%%>', ($ShowCancel ? '<button type="submit" class="btn btn-default" id="deselect" name="deselect_x" value="1" onclick="' . $backAction . '"><i class="glyphicon glyphicon-chevron-left"></i> ' . $Translation['Back'] . '</button>' : ''), $templateCode);
	}

	// set records to read only if user can't insert new records and can't edit current record
	if(($selected_id && !$AllowUpdate) || (!$selected_id && !$AllowInsert)){
		$jsReadOnly .= "\tjQuery('#call_back').replaceWith('<div class=\"form-control-static\" id=\"call_back\">' + (jQuery('#call_back').val() || '') + '</div>'); jQuery('#call_back-multi-selection-help').hide();\n";
		$jsReadOnly .= "\tjQuery('#seller_name').replaceWith('<div class=\"form-control-static\" id=\"seller_name\">' + (jQuery('#seller_name').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#phone').replaceWith('<div class=\"form-control-static\" id=\"phone\">' + (jQuery('#phone').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('input[name=priority]').parent().html('<div class=\"form-control-static\">' + jQuery('input[name=priority]:checked').next().text() + '</div>')\n";
		$jsReadOnly .= "\tjQuery('#location_city').replaceWith('<div class=\"form-control-static\" id=\"location_city\">' + (jQuery('#location_city').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#location_state').replaceWith('<div class=\"form-control-static\" id=\"location_state\">' + (jQuery('#location_state').val() || '') + '</div>'); jQuery('#location_state-multi-selection-help').hide();\n";
		$jsReadOnly .= "\tjQuery('#pickup_date').prop('readonly', true);\n";
		$jsReadOnly .= "\tjQuery('#pickup_dateDay, #pickup_dateMonth, #pickup_dateYear').prop('disabled', true).css({ color: '#555', backgroundColor: '#fff' });\n";
		$jsReadOnly .= "\tjQuery('#pickup_time').replaceWith('<div class=\"form-control-static\" id=\"pickup_time\">' + (jQuery('#pickup_time').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#street_address').replaceWith('<div class=\"form-control-static\" id=\"street_address\">' + (jQuery('#street_address').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#category').replaceWith('<div class=\"form-control-static\" id=\"category\">' + (jQuery('#category').val() || '') + '</div>'); jQuery('#category-multi-selection-help').hide();\n";
		$jsReadOnly .= "\tjQuery('#ref_listing').replaceWith('<div class=\"form-control-static\" id=\"ref_listing\">' + (jQuery('#ref_listing').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#ref_listing, #ref_listing-edit-link').hide();\n";
		$jsReadOnly .= "\tjQuery('#photo_1').replaceWith('<div class=\"form-control-static\" id=\"photo_1\">' + (jQuery('#photo_1').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#photo_2').replaceWith('<div class=\"form-control-static\" id=\"photo_2\">' + (jQuery('#photo_2').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#photo_3').replaceWith('<div class=\"form-control-static\" id=\"photo_3\">' + (jQuery('#photo_3').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#photo_4').replaceWith('<div class=\"form-control-static\" id=\"photo_4\">' + (jQuery('#photo_4').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#photo_5').replaceWith('<div class=\"form-control-static\" id=\"photo_5\">' + (jQuery('#photo_5').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('#photo_6').replaceWith('<div class=\"form-control-static\" id=\"photo_6\">' + (jQuery('#photo_6').val() || '') + '</div>');\n";
		$jsReadOnly .= "\tjQuery('.select2-container').hide();\n";

		$noUploads = true;
	}elseif(($AllowInsert && !$selected_id) || ($AllowUpdate && $selected_id)){
		$jsEditable .= "\tjQuery('form').eq(0).data('already_changed', true);"; // temporarily disable form change handler
		$jsEditable .= "\tjQuery('#pickup_time').addClass('always_shown').timepicker({ showSeconds: true, showMeridian: true, showInputs: false, disableFocus: true, minuteStep: 5 });";
			$jsEditable .= "\tjQuery('form').eq(0).data('already_changed', false);"; // re-enable form change handler
	}

	// process combos
	$templateCode=str_replace('<%%COMBO(call_back)%%>', $combo_call_back->HTML, $templateCode);
	$templateCode=str_replace('<%%COMBOTEXT(call_back)%%>', $combo_call_back->SelectedData, $templateCode);
	$templateCode=str_replace('<%%COMBO(priority)%%>', $combo_priority->HTML, $templateCode);
	$templateCode=str_replace('<%%COMBOTEXT(priority)%%>', $combo_priority->SelectedData, $templateCode);
	$templateCode=str_replace('<%%COMBO(location_state)%%>', $combo_location_state->HTML, $templateCode);
	$templateCode=str_replace('<%%COMBOTEXT(location_state)%%>', $combo_location_state->SelectedData, $templateCode);
	$templateCode=str_replace('<%%COMBO(pickup_date)%%>', ($selected_id && !$arrPerm[3] ? '<div class="form-control-static">' . $combo_pickup_date->GetHTML(true) . '</div>' : $combo_pickup_date->GetHTML()), $templateCode);
	$templateCode=str_replace('<%%COMBOTEXT(pickup_date)%%>', $combo_pickup_date->GetHTML(true), $templateCode);
	$templateCode=str_replace('<%%COMBO(category)%%>', $combo_category->HTML, $templateCode);
	$templateCode=str_replace('<%%COMBOTEXT(category)%%>', $combo_category->SelectedData, $templateCode);

	/* lookup fields array: 'lookup field name' => array('parent table name', 'lookup field caption') */
	$lookup_fields = array();
	foreach($lookup_fields as $luf => $ptfc){
		$pt_perm = getTablePermissions($ptfc[0]);

		// process foreign key links
		if($pt_perm['view'] || $pt_perm['edit']){
			$templateCode = str_replace("<%%PLINK({$luf})%%>", '<button type="button" class="btn btn-default view_parent hspacer-md" id="' . $ptfc[0] . '_view_parent" title="' . html_attr($Translation['View'] . ' ' . $ptfc[1]) . '"><i class="glyphicon glyphicon-eye-open"></i></button>', $templateCode);
		}

		// if user has insert permission to parent table of a lookup field, put an add new button
		if($pt_perm['insert'] && !$_REQUEST['Embedded']){
			$templateCode = str_replace("<%%ADDNEW({$ptfc[0]})%%>", '<button type="button" class="btn btn-success add_new_parent hspacer-md" id="' . $ptfc[0] . '_add_new" title="' . html_attr($Translation['Add New'] . ' ' . $ptfc[1]) . '"><i class="glyphicon glyphicon-plus-sign"></i></button>', $templateCode);
		}
	}

	// process images
	$templateCode=str_replace('<%%UPLOADFILE(id)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(call_back)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(seller_name)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(phone)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(purchase_notes)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(priority)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(location_city)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(location_state)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(pickup_date)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(pickup_time)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(street_address)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(category)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(ref_listing)%%>', '', $templateCode);
	$templateCode=str_replace('<%%UPLOADFILE(photo_1)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_1" id="photo_1">'), $templateCode);
	if($AllowUpdate && $row['photo_1']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_1)%%>', '<br><input type="checkbox" name="photo_1_remove" id="photo_1_remove" value="1"> <label for="photo_1_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_1)%%>', '', $templateCode);
	}
	$templateCode=str_replace('<%%UPLOADFILE(photo_2)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_2" id="photo_2">'), $templateCode);
	if($AllowUpdate && $row['photo_2']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_2)%%>', '<br><input type="checkbox" name="photo_2_remove" id="photo_2_remove" value="1"> <label for="photo_2_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_2)%%>', '', $templateCode);
	}
	$templateCode=str_replace('<%%UPLOADFILE(photo_3)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_3" id="photo_3">'), $templateCode);
	if($AllowUpdate && $row['photo_3']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_3)%%>', '<br><input type="checkbox" name="photo_3_remove" id="photo_3_remove" value="1"> <label for="photo_3_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_3)%%>', '', $templateCode);
	}
	$templateCode=str_replace('<%%UPLOADFILE(photo_4)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_4" id="photo_4">'), $templateCode);
	if($AllowUpdate && $row['photo_4']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_4)%%>', '<br><input type="checkbox" name="photo_4_remove" id="photo_4_remove" value="1"> <label for="photo_4_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_4)%%>', '', $templateCode);
	}
	$templateCode=str_replace('<%%UPLOADFILE(photo_5)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_5" id="photo_5">'), $templateCode);
	if($AllowUpdate && $row['photo_5']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_5)%%>', '<br><input type="checkbox" name="photo_5_remove" id="photo_5_remove" value="1"> <label for="photo_5_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_5)%%>', '', $templateCode);
	}
	$templateCode=str_replace('<%%UPLOADFILE(photo_6)%%>', ($noUploads ? '' : '<input type=hidden name=MAX_FILE_SIZE value=4096000>'.$Translation['upload image'].' <input type="file" name="photo_6" id="photo_6">'), $templateCode);
	if($AllowUpdate && $row['photo_6']!=''){
		$templateCode=str_replace('<%%REMOVEFILE(photo_6)%%>', '<br><input type="checkbox" name="photo_6_remove" id="photo_6_remove" value="1"> <label for="photo_6_remove" style="color: red; font-weight: bold;">'.$Translation['remove image'].'</label>', $templateCode);
	}else{
		$templateCode=str_replace('<%%REMOVEFILE(photo_6)%%>', '', $templateCode);
	}

	// process values
	if($selected_id){
		$templateCode=str_replace('<%%VALUE(id)%%>', html_attr($row['id']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(id)%%>', urlencode($urow['id']), $templateCode);
		$templateCode=str_replace('<%%VALUE(call_back)%%>', html_attr($row['call_back']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(call_back)%%>', urlencode($urow['call_back']), $templateCode);
		$templateCode=str_replace('<%%VALUE(seller_name)%%>', html_attr($row['seller_name']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(seller_name)%%>', urlencode($urow['seller_name']), $templateCode);
		$templateCode=str_replace('<%%VALUE(phone)%%>', html_attr($row['phone']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(phone)%%>', urlencode($urow['phone']), $templateCode);
		if($AllowUpdate || $AllowInsert){
			$templateCode = str_replace('<%%HTMLAREA(purchase_notes)%%>', '<textarea name="purchase_notes" id="purchase_notes" rows="5">' . html_attr($row['purchase_notes']) . '</textarea>', $templateCode);
		}else{
			$templateCode = str_replace('<%%HTMLAREA(purchase_notes)%%>', '<div id="purchase_notes" class="form-control-static">' . $row['purchase_notes'] . '</div>', $templateCode);
		}
		$templateCode=str_replace('<%%VALUE(purchase_notes)%%>', nl2br($row['purchase_notes']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(purchase_notes)%%>', urlencode($urow['purchase_notes']), $templateCode);
		$templateCode=str_replace('<%%VALUE(priority)%%>', html_attr($row['priority']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(priority)%%>', urlencode($urow['priority']), $templateCode);
		$templateCode=str_replace('<%%VALUE(location_city)%%>', html_attr($row['location_city']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(location_city)%%>', urlencode($urow['location_city']), $templateCode);
		$templateCode=str_replace('<%%VALUE(location_state)%%>', html_attr($row['location_state']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(location_state)%%>', urlencode($urow['location_state']), $templateCode);
		$templateCode=str_replace('<%%VALUE(pickup_date)%%>', @date('m/d/Y', @strtotime(html_attr($row['pickup_date']))), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(pickup_date)%%>', urlencode(@date('m/d/Y', @strtotime(html_attr($urow['pickup_date'])))), $templateCode);
		$templateCode=str_replace('<%%VALUE(pickup_time)%%>', time12(html_attr($row['pickup_time'])), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(pickup_time)%%>', urlencode(time12($urow['pickup_time'])), $templateCode);
		$templateCode=str_replace('<%%VALUE(street_address)%%>', html_attr($row['street_address']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(street_address)%%>', urlencode($urow['street_address']), $templateCode);
		$templateCode=str_replace('<%%VALUE(category)%%>', html_attr($row['category']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(category)%%>', urlencode($urow['category']), $templateCode);
		$templateCode=str_replace('<%%VALUE(ref_listing)%%>', html_attr($row['ref_listing']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(ref_listing)%%>', urlencode($urow['ref_listing']), $templateCode);
		$row['photo_1']=($row['photo_1']!=''?$row['photo_1']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_1)%%>', html_attr($row['photo_1']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_1)%%>', urlencode($urow['photo_1']), $templateCode);
		$row['photo_2']=($row['photo_2']!=''?$row['photo_2']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_2)%%>', html_attr($row['photo_2']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_2)%%>', urlencode($urow['photo_2']), $templateCode);
		$row['photo_3']=($row['photo_3']!=''?$row['photo_3']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_3)%%>', html_attr($row['photo_3']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_3)%%>', urlencode($urow['photo_3']), $templateCode);
		$row['photo_4']=($row['photo_4']!=''?$row['photo_4']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_4)%%>', html_attr($row['photo_4']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_4)%%>', urlencode($urow['photo_4']), $templateCode);
		$row['photo_5']=($row['photo_5']!=''?$row['photo_5']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_5)%%>', html_attr($row['photo_5']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_5)%%>', urlencode($urow['photo_5']), $templateCode);
		$row['photo_6']=($row['photo_6']!=''?$row['photo_6']:'blank.gif');
		$templateCode=str_replace('<%%VALUE(photo_6)%%>', html_attr($row['photo_6']), $templateCode);
		$templateCode=str_replace('<%%URLVALUE(photo_6)%%>', urlencode($urow['photo_6']), $templateCode);
	}else{
		$templateCode=str_replace('<%%VALUE(id)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(id)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(call_back)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(call_back)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(seller_name)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(seller_name)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(phone)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(phone)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%HTMLAREA(purchase_notes)%%>', '<textarea name="purchase_notes" id="purchase_notes" rows="5"></textarea>', $templateCode);
		$templateCode=str_replace('<%%VALUE(priority)%%>', 'Normal', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(priority)%%>', urlencode('Normal'), $templateCode);
		$templateCode=str_replace('<%%VALUE(location_city)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(location_city)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(location_state)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(location_state)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(pickup_date)%%>', '1', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(pickup_date)%%>', urlencode('1'), $templateCode);
		$templateCode=str_replace('<%%VALUE(pickup_time)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(pickup_time)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(street_address)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(street_address)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(category)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(category)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(ref_listing)%%>', '', $templateCode);
		$templateCode=str_replace('<%%URLVALUE(ref_listing)%%>', urlencode(''), $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_1)%%>', 'blank.gif', $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_2)%%>', 'blank.gif', $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_3)%%>', 'blank.gif', $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_4)%%>', 'blank.gif', $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_5)%%>', 'blank.gif', $templateCode);
		$templateCode=str_replace('<%%VALUE(photo_6)%%>', 'blank.gif', $templateCode);
	}

	// process translations
	foreach($Translation as $symbol=>$trans){
		$templateCode=str_replace("<%%TRANSLATION($symbol)%%>", $trans, $templateCode);
	}

	// clear scrap
	$templateCode=str_replace('<%%', '<!-- ', $templateCode);
	$templateCode=str_replace('%%>', ' -->', $templateCode);

	// hide links to inaccessible tables
	if($_REQUEST['dvprint_x'] == ''){
		$templateCode .= "\n\n<script>\$j(function(){\n";
		$arrTables = getTableList();
		foreach($arrTables as $name => $caption){
			$templateCode .= "\t\$j('#{$name}_link').removeClass('hidden');\n";
			$templateCode .= "\t\$j('#xs_{$name}_link').removeClass('hidden');\n";
		}

		$templateCode .= $jsReadOnly;
		$templateCode .= $jsEditable;

		if(!$selected_id){
			$templateCode.="\n\tif(document.getElementById('ref_listingEdit')){ document.getElementById('ref_listingEdit').style.display='inline'; }";
			$templateCode.="\n\tif(document.getElementById('ref_listingEditLink')){ document.getElementById('ref_listingEditLink').style.display='none'; }";
		}

		$templateCode.="\n});</script>\n";
	}

	// ajaxed auto-fill fields
	$templateCode .= '<script>';
	$templateCode .= '$j(function() {';


	$templateCode.="});";
	$templateCode.="</script>";
	$templateCode .= $lookups;

	// handle enforced parent values for read-only lookup fields

	// don't include blank images in lightbox gallery
	$templateCode = preg_replace('/blank.gif" data-lightbox=".*?"/', 'blank.gif"', $templateCode);

	// don't display empty email links
	$templateCode=preg_replace('/<a .*?href="mailto:".*?<\/a>/', '', $templateCode);

	// hook: acquisition_dv
	if(function_exists('acquisition_dv')){
		$args=array();
		acquisition_dv(($selected_id ? $selected_id : FALSE), getMemberInfo(), $templateCode, $args);
	}

	return $templateCode;
}
?>